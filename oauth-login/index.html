<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="index, follow"><title>第三方（微信、QQ）扫码登录设计 • 保持好奇心</title><meta name="description" content="第三方（微信、QQ）扫码登录设计 - roryye"><link rel="icon" href="/favicon.svg"><link rel="stylesheet" href="https://unpkg.com/nanoreset@3.0.1/nanoreset.min.css"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="保持好奇心"><link href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/KaTeX/0.10.2/katex.min.css" rel="stylesheet"><script type="text/javascript" id="maid-script" src="https://unpkg.com/mermaid@9.0.1/dist/mermaid.min.js?v=undefined"></script><script>if (window.mermaid) {
  var options = JSON.parse(document.getElementById('maid-script').getAttribute('mermaidoptioins'));
  mermaid.initialize(options);
}</script><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="保持好奇心" type="application/atom+xml">
</head><body><div class="wrap" id="barba-wrapper"><header><h1 class="branding"><a href="/" title="保持好奇心"><img class="logo-image" src="/logo.png" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link no-barba" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/about" target="_self">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="https://github.com/roryye" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/atom.xml" target="_self">RSS</a></li></ul></header><div class="barba-container"><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">第三方（微信、QQ）扫码登录设计</h1><div class="post-info"><a></a>2022-03-28</div><div class="post-content"><p>网站应用上的微信、QQ 扫码登陆是基于 OAuth 2.0 <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>协议来构建的，下图是微信扫码登陆获取 access_token 的时序图：<br />
<img src="../images/oauth_login/wx_login.png"/></p>
<p>为了更好的表现用户授权登陆和信息获取的整个流程，画出整体的时序图：</p>
<pre class="mermaid">sequenceDiagram
	autonumber
  用户 ->> 网站后台: 微信扫码登陆
	网站后台 ->> 微信开放平台: 请求微信 OAuth 2.0 授权登录
	微信开放平台 -->> 用户: 请求用户确认
	用户 ->> 微信开放平台: 确认登陆
	微信开放平台 -->> 用户: 重定向到第三方网页，带上授权临时票据 code
	用户 ->> 网站后台: 请求登录(携带 code)
	网站后台 ->> 微信开放平台: 使用 code、AppID、AppID 请求获取 access_token
	微信开放平台 -->> 网站后台: 返回 access_token，oppendid
	网站后台 ->> 微信开放平台: 使用 access_token，oppendid 获取用户个人信息
	微信开放平台 -->> 网站后台: 返回 nickname、sex、headimgurl 等
	网站后台 ->> 网站后台: 存储用户信息
	网站后台 -->> 用户: 返回</pre>
<p>针对上面的流程图的信息，第三方扫码登陆的 account.proto 设计如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line">package account.v1;</span><br><span class="line"></span><br><span class="line">option go_package = &quot;oauth-login/api/account/v1;v1&quot;;</span><br><span class="line"></span><br><span class="line">service Account &#123;</span><br><span class="line">  // 构建第三方登录 URL</span><br><span class="line">  rpc CreateOAuthURL(CreateOAuthURLReq) returns (CreateOAuthURLRsp);</span><br><span class="line"></span><br><span class="line">  // 校验第三方授权</span><br><span class="line">  rpc VerifyWithOAuth(VerifyWithOAuthReq) returns (VerifyWithOAuthRsp);</span><br><span class="line">	</span><br><span class="line">  // 第三方授权登录</span><br><span class="line">  rpc LoginWithOAuth(LoginWithOAuthReq) returns (LoginWithOAuthRsp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enum AuthType &#123;</span><br><span class="line">  AUTH_NONE = 0;</span><br><span class="line"></span><br><span class="line">  // QQ互联(auth_id=OAuth授权id)</span><br><span class="line">  AUTH_QQ = 1;</span><br><span class="line"></span><br><span class="line">  // 微信(auth_id=OAuth授权id)</span><br><span class="line">  AUTH_WECHAT = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message CreateOAuthURLReq &#123;</span><br><span class="line">  // 授权类型</span><br><span class="line">  AuthType auth_type = 1; </span><br><span class="line"></span><br><span class="line">  // 登录回调链接(丢弃query参数 部分OAuth不支持透传query参数)</span><br><span class="line">  string redirect_uri = 2;</span><br><span class="line"></span><br><span class="line">  // 回调后的下一跳链接</span><br><span class="line">  string next_url = 3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message CreateOAuthURLRsp &#123;</span><br><span class="line">  // 授权链接（即二维码）</span><br><span class="line">  string oauth_url = 1;</span><br><span class="line"></span><br><span class="line">  // 链接过期时间(秒)</span><br><span class="line">  int64 expires_in = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message VerifyWithOAuthReq &#123;</span><br><span class="line">  // 授权类型</span><br><span class="line">  AuthType auth_type = 1;</span><br><span class="line"></span><br><span class="line">  // 登录后的回调链接</span><br><span class="line">  string redirect_uri = 2;</span><br><span class="line"></span><br><span class="line">  // 登录回调链接的参数</span><br><span class="line">  string raw_query = 3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message VerifyWithOAuthRsp &#123;</span><br><span class="line">  // 回调后的下一跳链接</span><br><span class="line">  string next_url = 1;</span><br><span class="line"></span><br><span class="line">  // 授权id</span><br><span class="line">  string auth_id = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message LoginWithOAuthReq &#123;</span><br><span class="line">  // 授权类型</span><br><span class="line">  AuthType auth_type = 1;</span><br><span class="line"></span><br><span class="line">  // 授权id</span><br><span class="line">  string auth_id = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enum LoginStatus &#123;</span><br><span class="line">  UNSPECIFIED = 0;</span><br><span class="line">  SUCCESS = 1;</span><br><span class="line">  NEED_TO_REGISTER = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message LoginWithOAuthRsp &#123;LoginStatus status = 1;&#125;</span><br></pre></td></tr></table></figure>
<p>可用 Kratos <sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> 框架对 proto 生成桩代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kratos proto add api/account/v1/account.proto</span><br><span class="line"></span><br><span class="line">make api</span><br></pre></td></tr></table></figure>
<p>登陆接口交互的时序图如下:</p>
<pre class="mermaid">sequenceDiagram
	autonumber
	网页 ->>+ 后台服务: CreateOAuthURL<br>(生产授权链接)
	后台服务 -->>- 网页: 返回授权链接 oauth_url
	网页 ->> 网页: 扫码登陆
	网页 ->>+ 后台服务: VerifyWithOAuthReq(携带 code 等参数)
	后台服务 ->>+ 微信开放平台: 使用 code、AppID、AppID 请求获取 access_token
	微信开放平台 -->>- 后台服务: 返回 access_token，oppendid
	后台服务 -->>- 网页: 返回 auth_id
	网页 ->>+ 后台服务: LoginWithOAuth(携带 auth_id)
	后台服务 ->> 后台服务: 校验
	后台服务 -->>- 网页: 返回登录结果</pre>
<p>如上图所示，第 8 步把第 7 步返回的 auth_id 当作参数又对服务发起一次校验请求，第 8 步骤的请求也可以和第 4 步的合在一起。但是如果该网站是以手机号登录作为唯一，首次登录扫码后还需要用手机号码绑定，那么这两个接口并在一起就不合适了，需要再支持一个入参带有 phone 的接口 BindWithOauth 来替换第 8 步。</p>
<div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;"><a target="_blank" rel="noopener" href="https://oauth.net/2/">https://oauth.net/2/</a></span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">2.</span><span style="display: inline-block; vertical-align: top;"><a target="_blank" rel="noopener" href="https://go-kratos.dev/docs/getting-started/start">https://go-kratos.dev/docs/getting-started/start</a></span><a href="#fnref:2" rev="footnote"> ↩</a></li></ol></div></div></div></article></div></main><footer><div class="paginator"><a class="prev" href="/sms-verification-code/">prev</a><a class="next" href="/golang-slice/">next</a></div><div class="copyright"><p>保持好奇心 &copy; 2022 <a href="https://beian.miit.gov.cnt" rel="noreferrer" target="_blank">京ICP备2022015182号-1</a></p></div></footer></div></div><script>var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-XXXXXXXX-X']);
_gaq.push(['_trackPageview']);

(function () {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script><script src="https://cdnjs.cloudflare.com/ajax/libs/barba.js/1.0.0/barba.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {
    Barba.Pjax.start()
})</script></body></html>